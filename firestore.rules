rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function: check if user owns the document
    function isOwner(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Users collection: cada usuario solo puede leer/escribir su propio documento
    match /users/{uid} {
      allow create: if isAuthenticated() && request.auth.uid == uid;
      allow read, update, delete: if isOwner(uid);
    }

    // Fletes collection
    match /fletes/{fleteId} {
      // Lectura: cualquier usuario autenticado puede leer fletes
      allow read: if isAuthenticated();
      
      // Creación: solo el dueño (admin/cliente) puede crear fletes
      allow create: if isAuthenticated() 
        && request.resource.data.cliente_id == request.auth.uid;
      
      // Actualización: diferentes permisos según el caso
      allow update: if isAuthenticated() && (
        // El cliente que creó el flete puede hacer cualquier cambio
        request.auth.uid == resource.data.cliente_id
        
        // O el chofer asignado puede actualizar checkpoints y estado
        || (resource.data.transportista_asignado != null 
            && request.auth.uid == resource.data.transportista_asignado)
        
        // O cualquier chofer puede cambiar estado de 'disponible' a 'solicitado'
        // (cuando acepta un flete)
        || (resource.data.estado == 'disponible' 
            && request.resource.data.estado == 'solicitado')
      );
      
      // Eliminación: solo el dueño puede eliminar
      allow delete: if isAuthenticated() 
        && request.auth.uid == resource.data.cliente_id;

      // Subcollection: checkpoints
      match /checkpoints/{checkpointId} {
        // Lectura: cualquier autenticado puede leer
        allow read: if isAuthenticated();
        
        // Escritura: solo el chofer asignado al flete padre o el cliente dueño
        allow create, update: if isAuthenticated() && (
          (exists(/databases/$(database)/documents/fletes/$(fleteId))
           && get(/databases/$(database)/documents/fletes/$(fleteId)).data.transportista_asignado == request.auth.uid)
          || (exists(/databases/$(database)/documents/fletes/$(fleteId))
              && get(/databases/$(database)/documents/fletes/$(fleteId)).data.cliente_id == request.auth.uid)
        );
        
        // Eliminación: solo el cliente dueño
        allow delete: if isAuthenticated()
          && exists(/databases/$(database)/documents/fletes/$(fleteId))
          && get(/databases/$(database)/documents/fletes/$(fleteId)).data.cliente_id == request.auth.uid;
      }
      
      // Subcollection: fotos
      match /fotos/{fotoId} {
        // Lectura: cualquier autenticado
        allow read: if isAuthenticated();
        
        // Escritura: chofer asignado o cliente dueño
        allow create, update: if isAuthenticated() && (
          (exists(/databases/$(database)/documents/fletes/$(fleteId))
           && get(/databases/$(database)/documents/fletes/$(fleteId)).data.transportista_asignado == request.auth.uid)
          || (exists(/databases/$(database)/documents/fletes/$(fleteId))
              && get(/databases/$(database)/documents/fletes/$(fleteId)).data.cliente_id == request.auth.uid)
        );
        
        // Eliminación: solo cliente
        allow delete: if isAuthenticated()
          && exists(/databases/$(database)/documents/fletes/$(fleteId))
          && get(/databases/$(database)/documents/fletes/$(fleteId)).data.cliente_id == request.auth.uid;
      }
    }

    // Solicitudes collection
    match /solicitudes/{fleteId} {
      // Lectura: cualquier autenticado puede leer
      allow read: if isAuthenticated();
      
      // No se permite crear/actualizar/eliminar el documento padre directamente
      allow write: if false;

      // Subcollection: solicitantes
      match /solicitantes/{choferId} {
        // Lectura: cualquier autenticado puede leer
        allow read: if isAuthenticated();
        
        // Creación: el chofer puede crear su propia solicitud
        allow create: if isAuthenticated() 
          && request.auth.uid == choferId
          && request.resource.data.chofer_id == request.auth.uid;
        
        // Actualización: el chofer que creó O el cliente dueño del flete pueden actualizar
        allow update: if isAuthenticated() && (
          request.auth.uid == choferId
          || request.auth.uid == resource.data.cliente_id
        );
        
        // Eliminación: el chofer que la creó O el cliente pueden eliminar
        allow delete: if isAuthenticated() && (
          request.auth.uid == choferId
          || request.auth.uid == resource.data.cliente_id
        );
      }
    }
    
    // IMPORTANTE: Permitir collectionGroup queries en solicitantes
    match /{path=**}/solicitantes/{choferId} {
      allow read: if isAuthenticated();
    }

    // Catch-all: denegar todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
